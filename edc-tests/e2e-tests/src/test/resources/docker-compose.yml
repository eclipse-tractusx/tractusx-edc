#
#  Copyright (c) 2023 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)
#
#  See the NOTICE file(s) distributed with this work for additional
#  information regarding copyright ownership.
#
#  This program and the accompanying materials are made available under the
#  terms of the Apache License, Version 2.0 which is available at
#  https://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#  License for the specific language governing permissions and limitations
#  under the License.
#
#  SPDX-License-Identifier: Apache-2.0
#
version: '3'

volumes:
  postgres_data:
    driver: local

services:
  postgres:
    image: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db.sh:/docker-entrypoint-initdb.d/init-database.sh
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"

  wallet:
    platform: linux/amd64
    container_name: managed-identity-wallet
    image: ghcr.io/catenax-ng/tx-managed-identity-wallets_miw_service:0.0.1-snapshot.2994d69
    ports:
      - "8080:8080"
    environment:
      #application env variables need to setup in IDE
      APPLICATION_PORT: 8080
      APPLICATION_ENVIRONMENT: dev
      DB_HOST: postgres
      DB_PORT: 5432
      USE_SSL: 'false'

      #create miw database and update below properties
      DB_USER_NAME: keycloak
      DB_PASSWORD: password
      DB_NAME: miw
      KEYCLOAK_MIW_PUBLIC_CLIENT: miw_public
      MANAGEMENT_PORT: 8090
      MIW_HOST_NAME: localhost:8080
      ENFORCE_HTTPS_IN_DID_RESOLUTION: 'false'
      ENCRYPTION_KEY: Woh9waid4Ei5eez0aitieghoow9so4oe
      AUTHORITY_WALLET_BPN: BPNL000000000000
      AUTHORITY_WALLET_NAME: Catena-X
      AUTHORITY_WALLET_DID: "did:web:localhost:8080:BPNL000000000000"
      VC_SCHEMA_LINK: https://www.w3.org/2018/credentials/v1, https://catenax-ng.github.io/product-core-schemas/businessPartnerData.json
      SUMMARY_VC_SCHEMA_LINK: https://www.w3.org/2018/credentials/v1, https://catenax-ng.github.io/product-core-schemas/SummaryVC.json
      VC_EXPIRY_DATE: 01-01-2025
      SUPPORTED_FRAMEWORK_VC_TYPES: "cx-behavior-twin: Behavior Twin,cx-pcf: PCF,cx-quality: Quality,cx-resiliency: Resiliency,cx-sustainability: Sustainability,cx-traceability: ID_3.0_Trace"
      KEYCLOAK_REALM: miw_test
      KEYCLOAK_CLIENT_ID: miw_private_client
      AUTH_SERVER_URL: http://keycloak:8081
    entrypoint: ["java","-jar", "miw-latest.jar", "--spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8081/realms/miw_test"]
    depends_on: [ postgres , keycloak ]

  keycloak:
    image: quay.io/keycloak/keycloak:21.0.2
    environment:
      DB_VENDOR: POSTGRES
      DB_ADDR: postgres
      DB_DATABASE: keycloak
      DB_USER: keycloak
      DB_SCHEMA: public
      DB_PASSWORD: password
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    entrypoint: [ "/opt/keycloak/bin/kc.sh", "start-dev" ,"--import-realm", "--http-port=8081" ]
    volumes:
      - ./miw_test_realm.json:/opt/keycloak/data/import/miw_test_realm.json
    ports:
      - "8081:8081"
    depends_on:
      - postgres