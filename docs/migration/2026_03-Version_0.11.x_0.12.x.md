# Migration Guide `0.11.x -> 0.12.x`

This document outlines the necessary changes for migrating your tractusx-edc installation from versions 0.11.x to 0.12.x.
It also outlines some points that adopters and operators should pay close attention to when migrating from one version
to another.

This document is not a comprehensive feature list.

<!-- TOC -->
* [Migration Guide `0.11.x -> 0.12.x`](#migration-guide-011x---012x)
  * [1. Connector Discovery](#1-connector-discovery)
    * [Self-Registration of Connectors in DID Document](#self-registration-of-connectors-in-did-document)
    * [Discovery of Connectors](#discovery-of-connectors)
    * [Changed Param Discovery Request Body](#changed-param-discovery-request-body)
  * [2. Participant ID](#2-participant-id)
  * [3. Changed behavior for old policies](#3-changed-behavior-for-old-policies)
  * [4. Verifiable Presentation Caching](#4-verifiable-presentation-caching)
  * [5. Catalog response changes](#5-catalog-response-changes)
  * [6. Deprecated instances](#6-deprecated-instances)
<!-- TOC -->

## 1. Connector Discovery

### Self-Registration of Connectors in DID Document

The connector provides a new feature that automatically registers a running connectors in the DID documents service
section, so that it is published to be discovered by potential consumers. The feature is can be enabled. The following
three parameters allow you to influence the execution of this feature.

```properties
TX_EDC_DID_SERVICE_SELF_REGISTRATION_ENABLED=true
TX_EDC_DID_SERVICE_SELF_DEREGISTRATION_ENABLED=false
TX_EDC_DID_SERVICE_SELF_REGISTRATION_ID="did:web:connector_id"
```

The registration enabled parameter turns on self registration on startup. For a standard one instance connector
setup, it is recommended to also enable the deregistration enabled parameter, as this automatically deregisters the
connector during shutdown. This allows a full controlled life-cycle of the availability of the connector in the
decentral discovery. For setups with a scaling connector or other scenarios, where the availability of a connector is
not bound on it, currently executed, this auto deregistration leads to issues, that is, why it can the deregistration
can be disabled explicitly.

The third parameter is a requirement from the format given for service entries in a DID document. Such a record requires
a unique id for the connector, which is typically in the did format. The content actually is only used as a string, so
the concrete content has no further constraints bound to it.

Be aware, that in the standard helm charts, only the first and third parameter can be set in the values file:

```yaml
iatp:
  didService:
    selfRegistration:
      # -- Whether Service Self Registration is enabled
      enabled: false
      # -- Unique id of connector to be used for register / unregister service inside did document (must be valid URI)
      id: "did:web:changeme"
```

The value for the second parameter is determined from other parameters like the scaling setting for the deployment. If
an adopter wants to influence the deregistration procedure explicitly, he has to adapt the template setting for that
parameter.

### Discovery of Connectors

There is a new endpoint in the management api `/v4alpha/connectordiscovery/connectors` that supports the decentral
discovery of DSP endpoints. The api takes a did as parameter `edc:counterPartyId` and does the did based connector
endpoint retrieval according to the DSP spec. I.e., it downloads the DID document, searches for service entries of type
`DataService`. For each found endpoint, the version metadata endpoint is called to determine the dsp versions supported
by the connector and the appropriate one is selected. For each connector the right connection parameters are extracted
and returned as an array of connection parameters.

For the time being the parameter given to the endpoint can also be a BPNL, but it is strictly recommended to start with
the DID. The BPNL mechanism is only provided as legacy mechanism as long as central Catena-X mechanisms do not properly
allow to search for the DID of the counterparty.

For a proper discovery of connectors operated by a business partner, this method is strongly recommended to be used in
a proper discover, retrieve catalog, initiate data transfer cycle!

### Changed Param Discovery Request Body

The already existing management api endpoint `/v4alpha/connectordiscovery/dspversionparams`, introduced in version 0.11.0
has been adapted to be more neutral. For that reason, the endpoints payload now requires the two parameters
`counterPartyAddress` and `counterPartyId`. The latter has been renamed from the parameter name `bpnl`. It is
recommended to switch the parameter name in addressing the endpoint, for backward compatibility reasons, the parameter
`bpnl` still works but is a candidate to be removed in a later version.

## 2. Participant ID

In preparation of the new multi-tenancy ability of the connector, a participant context id has been introduced, that
represents the future tenant id. The new identifier is mandatory and has been added to the helm charts:

```yaml
participant:
  # -- BPN Number
  id: "BPNLCHANGEME"
  # -- Participant Context Id - Newly introduced id for a connector instance (needed for multitenancy)
  contextId: "UUID CHANGEME"
```
The actual setting/environment variable for the connector is named `EDC_PARTICIPANT_CONTEXT_ID`.

The participant context id is recommended to be a uuid. A minimum requirement is, that it can be used within a url path
as segment to make it usable for a tenant id later on.

Note, that the connector contains a code segment that prevents starting a connector, if the identifier is not set.

## 3. Changed behavior for old policies

There is a change when old policies are compacted in a response from the management api. The behavior in 0.12.0 is
breaking in contrast to Jupiter versions 0.10.x and earlier. The issue is, that with the redefinition of the policies,
the prefix json-ld `cx-policy` has been redefined for the new policies.

When creating an old policy at the management api, nothing changes, as you control the json-ld namespace, i.e., by using

```json
{
  "@context": {
    "cx-policy": "https://w3id.org/catenax/policy/"
  }
}
```

You still can refer to old policy terms in this way `cx-policy:UsagePurpose`. The issue is, that in the other direction,
when requesting a policy via the management api, the connector cannot compact anymore to `cx-policy:Usage-Purpose`
because in that direction, due to a breaking change in the Catena-X standardization, the prefix `cx-policy` is bound
to `https://w3id.org/catenax/2025/9/policy/`.

Due to a bug in 0.11.0 json-ld compacting is not done for Catena-X specifics in the management api, so 0.11.0 already has
breaking behavior in comparison with 0.10.x and earlier. In 0.12.0, we fix these deviations, but for old policies,
based on the `https://w3id.org/catenax/policy/` namespace, we cannot provide a solution, i.e., these terms in responses
from the management api will always be fully expanded. This is the only solution, that does not add a breaking change
on the level of json-ld, but a pure json based handling of responses will see unavoidable differences. 

## 4. Verifiable Presentation Caching

A new feature in the connector allows to cache verifiable presentations requested from the wallet to reduce the amount
of requests to the consumer wallet and to improve processing time. The feature as such is switchable, using the
boolean configuration parameter `TX_EDC_DCP_CACHE_ENABLED`. By default, it is enabled. A second parameter
`TX_EDC_DCP_CACHE_VALIDITY_SECONDS` allows for an enabled cache to define the length of the validity of a cache entry
in seconds. This defaults to 24h, as the development group rated the delayed recognition of a revoked credential as
acceptable. The settings can be changed with the mentioned parameters/environment variables. For the helm charts there
is a new section in the values file that allows the setting of the parameters.

```yaml
iatp:
  cache:
    # -- Whether the Verifiable Presentation cache is enabled
    enabled: true
    # -- Validity of the Verifiable Presentation cache in seconds
    validity: 86400
```

## 5. Catalog response changes

Starting with version 0.11.0, the catalog response returned by `/v3/catalog/request` was changed 
(see [walkthrough](../../docs/usage/management-api-walkthrough/04_catalog.md)). Each `distribution` entry now exposes its `format` 
as a simple string (for example `AzureStorage-PUSH`, `HttpData-PULL`, `AmazonS3-PUSH`), and the top-level service attribute 
is an array of `DataService` objects instead of a single object. This representation is emitted for DSP2025-1 catalogs and 
should be expected by clients. The legacy structure is still emitted only when interacting with DSP0.8 connectors for backward compatibility.

## 6. Deprecated instances

The `Data Plane Selector Configuration Extension` has been removed, as it has been deprecated since version 0.7.2.
Additionally, several configuration parameters deprecated since version 0.7.x have also been removed. 
Please use the updated configuration parameters instead.

[VaultSeedExtension](../../edc-controlplane/edc-runtime-memory/src/main/java/org/eclipse/tractusx/edc/vault/memory/VaultSeedExtension.java):

| Old value            | New value              | New environment variable |
|----------------------|------------------------|--------------------------|
| `edc.vault.secrets`  | `tx.edc.vault.secrets` | `TX_EDC_VAULT_SECRETS`   |


[BdrsClientExtension](../../edc-extensions/bdrs-client/src/main/java/org/eclipse/tractusx/edc/identity/mapper/BdrsClientExtension.java):

| Old value                            | New value                               | New environment variable                |
|--------------------------------------|-----------------------------------------|-----------------------------------------|
| `tx.iam.iatp.bdrs.server.url`        | `tx.edc.iam.iatp.bdrs.server.url`       | `TX_EDC_IAM_IATP_BDRS_SERVER_URL`       |
| `tx.iam.iatp.credentialservice.url`  | `tx.edc.iam.iatp.credentialservice.url` | `TX_EDC_IAM_IATP_CREDENTIALSERVICE_URL` |
| `tx.iam.iatp.bdrs.cache.validity`    | `tx.edc.iam.iatp.bdrs.cache.validity`   | `TX_EDC_IAM_IATP_BDRS_CACHE_VALIDITY`   |

[DataPlaneProxyConsumerApiExtension](../../edc-extensions/dataplane/dataplane-proxy/edc-dataplane-proxy-consumer-api/src/main/java/org/eclipse/tractusx/edc/dataplane/proxy/consumer/api/DataPlaneProxyConsumerApiExtension.java):

| Old value                             | New value                                     | New environment variable                      |
|---------------------------------------|-----------------------------------------------|-----------------------------------------------|
| `tx.dpf.consumer.proxy.port`          | `tx.edc.dpf.consumer.proxy.port`              | `TX_EDC_DPF_CONSUMER_PROXY_PORT`              |
| `tx.dpf.consumer.proxy.thread.pool`   | `tx.edc.dpf.consumer.proxy.thread.pool`       | `TX_EDC_DPF_CONSUMER_PROXY_THREAD_POOL`       |
| `edc.api.auth.key.alias`              | `tx.edc.dpf.consumer.proxy.auth.apikey.alias` | `TX_EDC_DPF_CONSUMER_PROXY_AUTH_APIKEY_ALIAS` |
| `edc.api.auth.key`                    | `tx.edc.dpf.consumer.proxy.auth.apikey`       | `TX_EDC_DPF_CONSUMER_PROXY_AUTH_APIKEY`       |

[DataPlaneTokenRefreshServiceExtension](../../edc-extensions/dataplane/dataplane-token-refresh/token-refresh-core/src/main/java/org/eclipse/tractusx/edc/dataplane/tokenrefresh/core/DataPlaneTokenRefreshServiceExtension.java):

| Old value                             | New value                                 | New environment variable                  |
|---------------------------------------|-------------------------------------------|-------------------------------------------|
| `edc.dataplane.token.expiry.tolerance`| `tx.edc.dataplane.token.expiry.tolerance` | `TX_EDC_DATAPLANE_TOKEN_EXPIRY_TOLERANCE` |
| `edc.dataplane.token.refresh.endpoint`| `tx.edc.dataplane.token.refresh.endpoint` | `TX_EDC_DATAPLANE_TOKEN_REFRESH_ENDPOINT` |
| `edc.dataplane.token.expiry`          | `tx.edc.dataplane.token.expiry`           | `TX_EDC_DATAPLANE_TOKEN_EXPIRY`           |

[RemoteTokenServiceClientExtension](../../edc-extensions/dcp/tx-dcp-sts-dim/src/main/java/org/eclipse/tractusx/edc/iam/dcp/sts/RemoteTokenServiceClientExtension.java):

| Old value              | New value                  | New environment variable |
|------------------------|----------------------------|--------------------------|
| `edc.iam.sts.dim.url`  | `tx.edc.iam.sts.dim.url`   | `TX_EDC_IAM_STS_DIM_URL` |

[AbstractPostgresqlMigrationExtension](../../edc-extensions/migrations/postgresql-migration-lib/src/main/java/org/eclipse/tractusx/edc/postgresql/migration/AbstractPostgresqlMigrationExtension.java):

| Old value                                                           | New value                                         | New environment variable                          |
|---------------------------------------------------------------------|---------------------------------------------------|---------------------------------------------------|
| `org.eclipse.tractusx.edc.postgresql.migration.<subsystem>.enabled` | `tx.edc.postgresql.migration.<subsystem>.enabled` | `TX_EDC_POSTGRESQL_MIGRATION_<SUBSYSTEM>_ENABLED` |
| `org.eclipse.tractusx.edc.postgresql.migration.schema`              | `tx.edc.postgresql.migration.schema`              | `TX_EDC_POSTGRESQL_MIGRATION_SCHEMA`              |
