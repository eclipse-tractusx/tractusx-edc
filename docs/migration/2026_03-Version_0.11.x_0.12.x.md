# Migration Guide `0.11.x -> 0.12.x`

This document outlines the necessary changes for migrating your tractusx-edc installation from versions 0.11.x to 0.12.x.
It also outlines some points that adopters and operators should pay close attention to when migrating from one version
to another.

This document is not a comprehensive feature list.

<!-- TOC -->
* [Migration Guide `0.11.x -> 0.12.x`](#migration-guide-011x---012x)
  * [1. Connector Discovery](#1-connector-discovery)
    * [Self-Registration of Connectors in DID Document](#self-registration-of-connectors-in-did-document)
    * [Discovery of Connectors](#discovery-of-connectors)
    * [Changed Param Discovery Request Body](#changed-param-discovery-request-body)
  * [2. Participant ID](#2-participant-id)
<!-- TOC -->

## 1. Connector Discovery

### Self-Registration of Connectors in DID Document

The connector provides a new feature that automatically registers a running connectors in the DID documents service
section, so that it is published to be discovered by potential consumers. The feature is can be enabled. The following
three parameters allow you to influence the execution of this feature.

```properties
TX_EDC_DID_SERVICE_SELF_REGISTRATION_ENABLED=true
TX_EDC_DID_SERVICE_SELF_DEREGISTRATION_ENABLED=false
TX_EDC_DID_SERVICE_SELF_REGISTRATION_ID="did:web:connector_id"
```

The registration enabled parameter turns on self registration on startup. For a standard one instance connector
setup, it is recommended to also enable the deregistration enabled parameter, as this automatically deregisters the
connector during shutdown. This allows a full controlled life-cycle of the availability of the connector in the
decentral discovery. For setups with a scaling connector or other scenarios, where the availability of a connector is
not bound on it, currently executed, this auto deregistration leads to issues, that is, why it can the deregistration
can be disabled explicitly.

The third parameter is a requirement from the format given for service entries in a DID document. Such a record requires
a unique id for the connector, which is typically in the did format. The content actually is only used as a string, so
the concrete content has no further constraints bound to it.

Be aware, that in the standard helm charts, only the first and third parameter can be set in the values file:

```yaml
iatp:
  didService:
    selfRegistration:
      # -- Whether Service Self Registration is enabled
      enabled: false
      # -- Unique id of connector to be used for register / unregister service inside did document (must be valid URI)
      id: "did:web:changeme"
```

The value for the second parameter is determined from other parameters like the scaling setting for the deployment. If
an adoptor wants to influence the deregistration procedure explicitly, he has to adapt the template setting for that
parameter.

### Discovery of Connectors

There is a new endpoint in the management api `/v4alpha/connectordiscovery/connectors` that supports the decentral
discovery of DSP endpoints. The api takes a did as parameter `edc:counterPartyId` and does the did based connector
endpoint retrieval according to the DSP spec. I.e., it downloads the DID document, searches for service entries of type
`DataService`. For each found endpoint, the version metadata endpoint is called to determine the dsp versions supported
by the connector and the appropriate one is selected. For each connector the right connection parameters are extracted
and returned as an array of connection parameters.

For the time being the parameter given to the endpoint can also be a BPNL, but it is strictly recommended to start with
the DID. The BPNL mechanism is only provided as legacy mechanism as long as central Catena-X mechanisms do not properly
allow to search for the DID of the counterparty.

For a proper discovery of connectors operated by a business partner, this method is strongly recommended to be used in
a proper discover, retrieve catalog, initiate data transfer cycle!

### Changed Param Discovery Request Body

The already existing management api endpoint `/v4alpha/connectordiscovery/dspversionparams`, introduced in version 0.11.0
has been adapted to be more neutral. For that reason, the endpoints payload now requires the two parameters
`counterPartyAddress` and `counterPartyId`. The latter has been renamed from the parameter name `bpnl`. It is
recommended to switch the parameter name in addressing the endpoint, for backward compatibility reasons, the parameter
`bpnl` still works but is a candidate to be removed in a later version.

## 2. Participant ID

In preparation of the new multi-tenancy ability of the connector, a participant context id has been introduced, that
represents the future tenant id. The new identifier is mandatory and has been added to the helm charts:

```yaml
participant:
  # -- BPN Number
  id: "BPNLCHANGEME"
  # -- Participant Context Id - Newly introduced id for a connector instance (needed for multitenancy)
  contextId: "UUID CHANGEME"
```
The actual setting/environment variable for the connector is named `EDC_PARTICIPANT_CONTEXT_ID`.

The participant context id is recommended to be a uuid. A minimum requirement is, that it can be used within a url path
as segment to make it usable for a tenant id later on.

Note, that the connector contains a code segment that prevents starting a connector, if the identifier is not set.
