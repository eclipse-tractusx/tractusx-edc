# Migration Guide `0.10.x -> 0.11.x`

This document outlines the necessary changes for migrating your tractusx-edc installation from versions 0.10.x to 0.11.0.
It also outlines some points that adopters and operators should pay close attention to when migrating from one version
to another.

This document is not a comprehensive feature list.

<!-- TOC -->
* [Migration Guide `0.10.x -> 0.11.x`](#migration-guide-010x---011x)
  * [1. DCP version 1.0](#1-dcp-version-10)
  * [2. Participant ID](#2-participant-id)
  * [3. Protocol handling for different versions](#3-protocol-handling-for-different-versions)
  * [4. Policy validations and general policy handling according to standard CX-0152](#4-policy-validations-and-general-policy-handling-according-to-standard-cx-0152)
    * [Impact on migration](#impact-on-migration)
<!-- TOC -->

## 1. DCP version 1.0

Tractus-X EDC now uses DCP 1.0 by default â€” no switch is required. If DCP 0.8.1 was previously forced via `edc.dcp.v08.forced`,
that setting should be removed; it is deprecated and no flag is provided for 1.0.

## 2. Participant ID

Previously, the BPN was used as the EDC's participant identifier. Starting with `0.11.0`, the primary participant
identifier is now the DID. As the BPN is still required for some processes and also will be used for communication
with older Tractus-X EDC versions, it now needs to be supplied via a new setting. Therefore, the configuration should
be updated as follows:

```properties
edc.participant.id=<did>
tractusx.edc.participant.bpn=<bpn>
```

## 3. Protocol handling for different versions

The `0.11.0` Tractus-X EDC supports both the previously supported 0.8 version of DSP as well as the new 2025-1 version
of DSP. It is in the responsibility of the caller of a management api call to identify the version to be used. The relevant
properties are `counterPartyAddress`, as the EDC supports different versions as own subtrees in the rest api hierarchy,
`protocol` and `counterPartyId`, resp. `policy/assigner`. For a standard runtime, the parameters have to be set:

Properties to be used for version 0.8:

```properties
counterPartyAddress=https://<provider-connector-url>/api/v1/dsp
protocol=dataspace-protocol-http
counterPartyId, resp. policy/assigner=<provider-bpn>
```

For version 2025-1:

```properties
counterPartyAddress=https://<provider-connector-url>/api/v1/dsp/2025-1
protocol=dataspace-protocol-http:2025-1
counterPartyId, resp. policy/assigner=<provider-did>
```

The property values to be used for a specific connector can be retrieved from the new management endpoint
`/v4alpha/connectordiscovery/dspversionparams`. It takes as request parameter a payload like:

```json
{
  "@context": {
    "tx": "https://w3id.org/tractusx/v0.0.1/ns/",
    "edc": "https://w3id.org/edc/v0.0.1/ns/"
  },
  "tx:bpnl": "BPNL1234567890",
  "edc:counterPartyAddress": "https://provider.domain.com/api/v1/dsp"
}  
```

As response, it returns all the right version parameter for that connector, depending on whether it supports
DSP 2025-1 or only the old protocol 0.8. For the above example, it would return for version 0.8:

```json
{
  "https://w3id.org/edc/v0.0.1/ns/counterPartyAddress": "https://provider.domain.com/api/v1/dsp/",
  "https://w3id.org/edc/v0.0.1/ns/counterPartyId": "BPNL1234567890",
  "https://w3id.org/edc/v0.0.1/ns/protocol": "dataspace-protocol-http"
}
```

and for version 2025-1:

```json
{
  "https://w3id.org/edc/v0.0.1/ns/counterPartyAddress": "https://provider.domain.com/api/v1/dsp/2025-1",
  "https://w3id.org/edc/v0.0.1/ns/counterPartyId": "<provider-did>",
  "https://w3id.org/edc/v0.0.1/ns/protocol": "dataspace-protocol-http:2025-1"
}
```

## 4. Policy validations and general policy handling according to standard CX-0152

Standard CX-0152 specifies a set of standardized contract building blocks that can be used within policies to express
the usage conditions for a data transfer as well as the access filters used by a provider to select data offers for a
catalog request. The new connector version 0.11.0 provides validation of the correct usage of these building blocks
during creation of a policy. Policies are now validated in their entirety including action types, rule types,
constraint logic, left and right operand values, as well as operators.

The introduction of the new standard CX-0152 comes with another consequence. As the formal specification of the building
blocks have been improved, all existing left operands have been moved to a different JSON-LD namespace. The consequence
is that a policy which is valid in a Jupiter dataspace has to be adapted to be usable in a Saturn dataspace. It was
the decision of the Catena-X standardization body, that it is acceptable for all data provider to duplicate contract
definitions, having one contract definition targeted to consumer acting on Jupiter level and one contract definition
targeted at consumer acting on Saturn level. Each contract definition has a usage policy with building blocks defined
either for a Jupiter consumer or a Saturn consumer. This way, backward compatibility is ensured, as a provider can do
data transfer offers for both ecosystem versions.

The handling of the different policies has been connected to the DSP version used for the interaction. Due to the
introduction of DSP version 2025-1 as mandatory DSP version used on Saturn level, usage policies fulfilling the Jupiter
standard are handled by the DSP version 0.8 support within the connector, whereas usage policies fulfilling the Saturn
standard are handled by the DSP version 2025-1 support.

A consequence of this is that a consumer sees both offers and has to decide based on his own capabilities (Jupiter or
Saturn), which offer to negotiate for. The difference can be determined by the namespace used for defining the operands.
A policy defined by CX-0152 will have a context binding like this:

```json
{
  ...,
  "@context": [
    "https://w3id.org/catenax/2025/9/policy/context.jsonld",
    ...,
  ],
  ...
}
```

Another impact on the new policies affects access policies, i.e., the policies in a contract definition that are used
to filter catalog entries. Access policies are not in the scope of backward compatibility, i.e., an access policy never
leaves the provider connector. As a consequence, in a connector of version 0.11.0, only policies according to CX-0152 on
Saturn level are usable, old access policies are not evaluated correctly, i.e., a contract definition that uses such
a policy will never be visible in a catalog.

### Impact on migration

For someone updating a connector from a version 0.10.0 or earlier to 0.11.0, the mentioned aspects have the following
consequences:

- A migration in principle is possible, the database will be updated to support the new connector version and all
  table content will be kept as is.
- The existing usage policies can be used for contract definitions targeted at Jupiter consumers.
- The existing access policies become obsolete, as the general semantic has not changed, a simple conversion of the
  existing policies can be done. The basic change is the new namespace that is needed for the building blocks used in 
  the policy. As a consequence a requested catalog will not contain any contract offer that makes use of an old access
  policy after the upgrade to 0.11.
- The existing contract definitions need to be adapted to a new access policy. These adapted contract definition will 
  then fulfill the purpose of defining data offers for Jupiter consumers.
- The existing contract definitions should be copied and redefined with a new usage policy to make data offers for
  Saturn consumers.
- The migration and duplication of offers can of course be influenced by knowledge you have about potential consumers,
  e.g., if you have contract definitions for very dedicated consumers, and you know their update strategy, concerning
  Saturn, you can postpone the creation of new contract definitions until needed by that customer and can delete
  existing definition as soon as the consumer has switched.

For more information on the CX-0152 standard, please refer to the official specification. The following link to the
standard might break soon enough, when CX-0152 becomes active in the Saturn ecosystem release, remove the *next* path
part in that case.
- [Catena-X Dataspace Policy Standard (CX-0152)](https://catenax-ev.github.io/docs/next/standards/CX-0152-PolicyConstrainsForDataExchange)

There is an extensive documentation on contracting in Catena-X in the regulatory framework:
- [Catena-X Regulatory Framework - Contracting](https://catenax-ev.github.io/docs/next/regulatory-framework/Contracting/Guidance:%20Contract%20Modularization)

A recommended playground to experiment with the new policies is the Policy Builder which will soon be an Eclipse
Tractus-X offer, but so far, it can be found here:
- [Catena-X Policy Builder](https://fraunhoferisst.github.io/edc-dashboard/policy-builder/)
