# Control Plane

The Eclipse Dataspace Connector consists of a **Control Plan** and a **Data Plane** Application.
While the **Data Plane** handles the actual Data Transfer, the **Control Plane** is responsible for:

- Resource Management (e.g. Assets, Policies & Contract Definitions CRUD)
- Contract Offering & Contract Negotiation
- Data Transfer Coordination / Management

# Control Plane Setup

This chapter is about integration the Control Plane with the Azure KeyVault and IDS DAPS.


----

**Please note**
</br>
The documentation operates the Azure Key Vault using the Azure CLI. Please visit the Microsoft has documented to learn how the Azure CLI is installed.
</br>
https://docs.microsoft.com/en-us/cli/azure/install-azure-cli

----

## Azure Key Vault Setup

The Eclipse Dataspace Connector requires a key vault, where it can store and retrieve secrets and certificates. </br>
At the time of writing the only key vault, the EDC is supporting, is the Azure Key vault.

### 1. Register a new App

In the Azure Portal:

1. Open **App registrations** page and create a new app
2. Choose a unique name and click _register_
3. The new App has a **Client ID** (also called Application ID). This ID must be configured in the connector
   setting `edc.vault.clientid`

For further information have a look at the official documentation </br>
https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app

### 2. Create App Secret

In the Azure Portal:

1. Open the page of the newly created app
2. On the left side select _certificates & secrets_
3. Create a new _client secret_
4. Add the secret value to the connector setting `edc.vault.clientsecret`

For further information have a look at the official documentation </br>
https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app#add-credentials

### 3. Create Azure Key Vault

In the Azure Portal:

1. Open **Key vaults** page and create a new Azure Key Vault
2. Fill out the mandatory fields, choose a unique key vault name and click _review + create_
3. The chosen name must be configured in the connector setting `edc.vault.name`
4. The directory ID of the key vault (also called tenant ID) must be configured in the `edc.vault.tenantid`

For further information have a look at the official documentation </br>
https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app

### 4. Provide the newly created App access to the Key Vault

In the Azure Portal:

1. Open the page of the newly created key vault
2. On the left side select _access policies_
3. Create new _access policy_ and select the appropriate permissions
5. Under _select principal_ add the newly created app from step 1
6. Click _add_

For further information have a look at the official documentation </br>
https://docs.microsoft.com/en-us/azure/key-vault/general/assign-access-policy?tabs=azure-portal

### 5. Summary

The complete Azure Key Vault configuration in the EDC should look something like this

```properties
edc.vault.tenantid=<aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa>
edc.vault.clientid=<bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb>
edc.vault.clientsecret=<ccccc~ccccccccc-cccccccccccccccccc>
edc.vault.name=<ddddd>
```

Please note that the key vault could also be configured using the `edc.vault.certificate`, which is not covered by this
documentation.

## IDS DAPS Setup

The Eclipse Dataspace Connector is able to retrieve an identity token from the IDS DAPS. This token is part of all IDS
messages.

The DAPS application requires a certificate from the Eclipse Dataspace Connector. This certificate may then be used by
the EDC connector to retrieve its identity token and prove its identity to other connectors.

When writing this guidance these step were tested out using the open source omejdn DAPS of the Fraunhofer
AISEC ([GitHub](https://github.com/International-Data-Spaces-Association/omejdn-daps)).

---
**Client Unknown Issue:**
</br>
Pleaste know that, in the past there were some DAPS issues with the client certificate. If you see this error, please contact the DAPS Team so that they can support you.

```json
{ "error":"invalid_client","error_description":"Client unknown"}
```
---


### (optional) 1. Key / Certificate Generation

In the first step generate a PKSC8 Key and the corresponding certificate. This step is optional, because it might be possible that this key is provided by the DAPS maintainers.

```bash
# Generate Private Key
openssl genpkey -out daps_key.pem -algorithm RSA -pkeyopt rsa_keygen_bits:2048
```

```bash
# Generate Certificate
openssl req -new -x509 -key daps_key.pem -nodes -days 365 -out daps_cert.pem
```

In case the certificate was not generated by the DAPS maintainers themself, it needs to be send to them. After the DAPS maintainers have registered a new client, it gets a unique client ID. Configure the DAPS client ID in  `edc.oauth.client.id`.

### 2. Azure Key Vault Upload

```bash
# Upload Private Key
az keyvault secret set --name my-daps-key --vault-name tree512 --file daps_key.pem
```

```bash
# Upload Certificate
az keyvault secret set --name my-daps-cert --vault-name tree512 --file daps_cert.pem
```

### 3. EDC Configuration

Configure the private key alias in the `edc.oauth.private.key.alias`, and the certificate alias in `edc.oauth.public.key.alias`.

In this example it would be
```properties
edc.oauth.private.key.alias=my-daps-key
edc.oauth.public.key.alias=my-daps-cert
```

Additionally these properties must be requested from the DAPS maintainers:

- DAPS Connector Client ID must be configured in `edc.oauth.client.id`
- DAPS Token URL must be configured in `edc.oauth.token.url`
- DAPS JWKS URL must be configured in `edc.oauth.provider.jwks.url`
- Token Audience must be configured in `edc.oauth.provider.audience`

### 4. Summary

The complete EDC configuration could look like this:

```properties
# DAPS Properties
edc.oauth.token.url=http://localhost:4567/token
edc.oauth.client.id=<clientId>
edc.oauth.provider.audience=<audience>
edc.oauth.provider.jwks.url=http://localhost:4567/.well-known/jwks.json
# OAUTH Properties
edc.oauth.private.key.alias=<key-alias>
edc.oauth.public.key.alias=<cert-alias>
```

## Dataplane Setup

Configure the control plane so that is able to communicate with an EDC data plane instance.

----

**Please note**
</br>
This chapter contains only the mandatory data plane configuration.

----

### Encryption

The communication between dataplane and controlplane is encrypted and needs some keys in the key vault and configuration in the EDC.

#### Private Key

```bash
# Generate Private Key
openssl genpkey -out my-data-plane-private-key.pem -algorithm RSA -pkeyopt rsa_keygen_bits:2048
```

```bash
# Upload Private Key
az keyvault secret set --name my-data-plane-private-key --vault-name tree512 --file my-data-plane-private-key.pem
```

```properties
# Configuration
edc.transfer.proxy.token.signer.privatekey.alias=my-data-plane-private-key
```

#### Public Key

```bash
# Generate Public Key
openssl rsa -in my-data-plane-private-key.pem -out my-data-plane-public-key.pem -pubout -outform PEM
```

```bash
# Upload Public Key
az keyvault secret set --name my-data-plane-public-key --vault-name tree512 --file my-data-plane-public-key.pem
```

```properties
# Configuration
edc.transfer.proxy.token.verifier.publickey.alias=my-data-plane-public-key
```


# Short Overview of the EDC Domain

This chapter gives a short overview of the EDC domain. The idea is to get a basic understanding of the domain objects and their roles.</br>
The complete EDC documentation can be found in the official open source [EDC GitHub Repository](https://github.com/eclipse-dataspaceconnector/DataSpaceConnector).

----

**Please note**
</br>
If you have already used the Fraunhofer Dataspace Connector, you are probably familiar with the IDS Domain Model. Don't confuse the IDS Domain Model with the EDC Domain Model.
The terms that are used in both models are pretty similar, but often don't represent the same thing. In the context of the EDC documentation it’s always safe to assume that the EDC Domain Model is in place, as the IDS model is only used when two Eclipse Dataspace COnnectors are exchanging messages.

----

## Contract Offer Exchange

In the EDC it’s not possible to create a _ContractOffer_ directly. The _ContractOffer_ is generated on the fly when
another connector asks about the _ContractOfferCatalog_. A _ContractOffer_ will only ge persistent when it becomes part of a
_ContractNegotiation_.

A _ContractDefinition_ defines how many _ContractOffers_ should be generated and how the _Policy_ should
look like.

The _ContractDefinition_ consists of a

- _ContractPolicy_, that describes in EDC ODRL terms how the policy for a _ContractOffer_ should look like.
- _AccessPolicy_, that describes in EDC ODRL terms who is able to see a _ContractOffer_. But the content of this policy
  will not be part of the _ContractOffer_.
- _AssetSelector_, that defines for which _Assets_ a _ContractOffer_ should be generated. An _Asset_ describes the data
  itself that may be offered/transferred and is comparable to the IDS triplet of IDS-Resource, IDS-Representation, IDS
  Artifact.

So the ContractDefinition looks somewhat like this:

<!--
Original PlantUML to update the ContractDefinition
---
@startuml

class ContractDefinition {
+String id
+Policy accessPolicy
+Policy contractPolicy
+AssetSelectorExpression selectorExpression
}
@enduml
-->

![test](http://www.plantuml.com/plantuml/png/PSvD2a9130FWVKyn-tU99-fUU2SOEbKAOqUQ28fuTnL_DYxpGK9ci2RFnowYlG9bFO9PbHlRUpXzHBd9j30z3iMRJBlHNQ-bgXhm3Z_KJ_dBAy2uM3VboEtbb0Qy5l57SXUHsQ8zhpm0)

When another connector asks the EDC about its _ContractOffers_ it:

- Checks the connector identity
- Finds all the _ContractDefinitions_ that have a passing AccessPolicy
- Finds for each passing _ContractDefinition_ the corresponding _Assets_
- Generates a new _ContractOffer_ for each _Asset_. The policy of the _ContractOffer_ is described in the ContractPolicy of the _ContractDefinition_.
- Maps the content of the _ContractOffer_ into the IDS domain and sends an IDS-ContractOffers to the other connector.
- The other connector then maps the IDS-ContractOffers back into its EDC domain and can then processes the _ContractOffer_.

# Data Management API

The documentation of the Data Management API can be found in the official open
source [EDC GitHub Repository](https://github.com/eclipse-dataspaceconnector/DataSpaceConnector).

The complete Eclipse Dataspace Connector API is described in the [EDC Open API Specification](https://github.com/eclipse-dataspaceconnector/DataSpaceConnector/blob/main/resources/openapi/openapi.yaml). Please be aware that this specification contains all APIs, that are implemented in the open source repository. The extensions, that implement those APIs, might not be part of the Control- and/or Data-Plane applications in this repository. Additionally, depending on the extension configuration, the documented paths might be only reachable using the configured ports.

## Contract Offer Exchange

----

**Please note**</br>
This chapter showcases the contract offer exchange between two connectors. It should function as starting point when working the Eclipse Dataspace Connector API. For a more detailed explanation of the various topics, that are touched in this section, please consolidate the official documentation in the [EDC GitHub Repository](https://github.com/eclipse-dataspaceconnector/DataSpaceConnector).

----

As described in the chapter about the EDC domain, the following resources must be created at the data provider:

- **Asset** (& DataAddress), describing the data and how it can be transferred
- **Policy**, as Contract- and/or AccessPolicy of the _ContractDefinition_
- **ContractDefinition**, for the contract offer generation

### 0. Calling the Data Management API

The Data Management API is secured with an API key. The value of this key can be configured in `edc.api.auth.key` and
should then be passed in the header as `X-API-Key: <api-auth-key>`.
Additionally, most or all of the API methods accept only JSON content, therefore adding `Content-Type: application/json`
to the header for most of the calls is recommended.

### 1. Create Asset using Data Mgmt API

#### Bash Script

```bash
# Variables (please update before running the script)
__connectorUrl=http://localhost:8181
__dataMgmtPath=data-mgmt
__apiKey=X-Api-Key
__apiKeyValue=pwd
__assetId=1
__assetDescription="Demo Asset"
__assetDataEndpoint="https://jsonplaceholder.typicode.com/todos/3"

__asset="{
        \"asset\": {
            \"properties\": {
                \"asset:prop:id\": \"$__assetId\",
                \"asset:prop:description\": \"$__assetDescription\"
            }
        },
        \"dataAddress\": {
            \"properties\": {
                \"type\": \"HttpProxy\",
                \"endpoint\": \"$__assetDataEndpoint\"
            }
        }
    }"

# Call Data Management API
curl -X POST "$__connectorUrl/$__dataMgmtPath/assets" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" --data "$__asset"
```

#### Bash Parameters

| Name                 | Description                                                                               |
| -------------------- | ----------------------------------------------------------------------------------------- |
| $__connectorUrl      | URL of the Connector with the Data Management API port configured in `web.http.data.port` |
| $__dataMgmtPath      | Path of the Data Management API as configured in `web.http.data.path`                     |
| $__apiKey            | Should always be _X-Api-Key_ for the Data Management API                                  |
| $__apiKeyValue       | The API Key Value as configured in `edc.api.auth.key`                                     |
| $__assetId           | Unique identifier of the asset                                                            |
| $__assetDescription  | Description of the asset                                                                  |
| $__assetDataEndpoint | Endpoint that might be used when data is transferred. Irrelevant in this context / sample |

#### Control Call

Get Asset

```bash
curl -X GET "$__connectorUrl/$__dataMgmtPath/assets/$__assetId" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" | jq
```

### 2. Create Policy

**Please be aware that the following policy make the data offer public for everyone and should be used with caution outside of this showcase!**

Create a policy that can be used by the __ContractDefinition__. As the same policy may be used as contract- and access policy of the ContractDefinition, creating only one policy for both cases is totally fine for this demo.

#### Bash Script

```bash
# Variables
__connectorUrl=http://localhost:8181
__dataMgmtPath=data-mgmt
__apiKey=X-Api-Key
__apiKeyValue=pwd
__policyId=1

__publicPolicy="
{
    \"uid\": \"$__policyId\",
    \"prohibitions\": [],
    \"obligations\": [],
    \"permissions\": [
        {
            \"edctype\": \"dataspaceconnector:permission\",
            \"action\": {
                \"type\": \"USE\" 
            },
        }
    ]
}"

# Call Data Mgmt API
curl -X POST "$__connectorUrl/$__dataMgmtPath/policies" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" --data "$__publicPolicy"
```

#### Bash Parameters

| Name            | Description                                                                               |
| --------------- | ----------------------------------------------------------------------------------------- |
| $__connectorUrl | URL of the Connector with the Data Management API port configured in `web.http.data.port` |
| $__dataMgmtPath | Path of the Data Management API as configured in `web.http.data.path`                     |
| $__apiKey       | Should always be _X-Api-Key_ for the Data Management API                                  |
| $__apiKeyValue  | The API Key Value as configured in `edc.api.auth.key`                                     |
| $__policyId     | Unique identifier of the policy.                                                          |

#### Control Call

Get Policy

```bash
curl -X GET "$__connectorUrl/$__dataMgmtPath/policies/$__policyId" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" | jq
```

### 3. Create Contract Definition

The following uses the previously created public policy make the data offer available for everyone.

#### Bash Script

```bash
# Variables
__connectorUrl=http://localhost:8181
__dataMgmtPath=data-mgmt
__apiKey=X-Api-Key
__apiKeyValue=pwd
__contractDefinitionId=1
__policyId=1
__assetId=1

__publicContractDefinition="
        {
            \"id\": \"$__contractDefinitionId\",
            \"accessPolicyId\": \"$__policyId\",
            \"contractPolicyId\": \"$__policyId\",
            \"criteria\": [
                {
                    \"left\": \"asset:prop:id\",
                    \"op\": \"=\",
                    \"right\": \"$__assetId\"
                }
            ]
        }"

# Call Data Mgmt API
curl -X POST "$__connectorUrl/$__dataMgmtPath/contractdefinitions" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" --data "$__publicContractDefinition"
```

#### Bash Parameters

| Name                    | Description                                                                               |
| ----------------------- | ----------------------------------------------------------------------------------------- |
| $__connectorUrl         | URL of the Connector with the Data Management API port configured in `web.http.data.port` |
| $__dataMgmtPath         | Path of the Data Management API as configured in `web.http.data.path`                     |
| $__apiKey               | Should always be _X-Api-Key_ for the Data Management API                                  |
| $__apiKeyValue          | The API Key Value as configured in `edc.api.auth.key`                                     |
| $__contractDefinitionId | Unique identifier of the contract definition.                                             |
| $__policyId             | Unique identifier of the policy. Must be the same ID as in step 2.                        |
| $__assetId              | Unique identifier of the asset. Must be the same ID as in step 1.                         |

#### Control Call

Get Contract Definition

```bash
curl -X GET "$__connectorUrl/$__dataMgmtPath/contractdefinitions/$__contractDefinitionId" --header "$__apiKey: $__apiKeyValue" --header "Content-Type: application/json" | jq
```

# Secure your connector

## API Security

The only API that is protected by some kind of security mechanism is the Data Management API. At the time of writing this is done by a simple API key.
The key value must be configured in `edc.api.auth.key`. All requests to the Data Management API must have `X-Api-Key` header with the key value.

Example:
```bash
curl -X GET <URL> --header "X-Api-Key: <edc.api.auth.key>"
```

# Known Control Plane Issues

Please have look at all the open issues in the open source repository. The list below might not be maintained well and
only contains the most important issues.
EDC Github Repository https://github.com/eclipse-dataspaceconnector/DataSpaceConnector/issues

## Contract negotiation not working when `web.http.ids.path` is configured/changed

https://github.com/eclipse-dataspaceconnector/DataSpaceConnector/issues/1249

**Workaround:**
Don't configure `web.http.ids.path`, so that the default path is used.

## Contract negotiation not working when initiated with policy id

https://github.com/eclipse-dataspaceconnector/DataSpaceConnector/issues/1251

**Workaround:**
The DataManagement API can also initiate a contract negotiation using the actual policy object.

## Non-IDS-Transformable-ContractDefinition causes connector to be unable to send out self-descriptions/catalogs

https://github.com/eclipse-dataspaceconnector/DataSpaceConnector/issues/1265

**Solution**
Delete non-transformable ContractDefinition or Policy.
